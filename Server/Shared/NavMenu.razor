@using Microsoft.AspNetCore.Identity
@using Server.Models
@using Server.Services
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject SalesCategoryService SalesCategoryService
@inject ILocalizationService LocalizationService
@inject StateContainer StateContainer
@implements IDisposable
@inject ILogger<NavMenu> Logger
@inject UserModuleAccessService UserModuleAccessService
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="sidebar">
    <div class="nav-header">
        <h4>Accounting System</h4>
    </div>

    <nav class="flex-column">
        <div class="nav-item">
            <NavLink class="nav-link" href="subjects">  @* Changed from "subjektet" *@
                <span>Subjects</span>
            </NavLink>
        </div>

        <div class="nav-item">
            <NavLink class="nav-link" href="blerje">
                <span>Blerje</span>
            </NavLink>
        </div>

        <div class="nav-item">
            <NavLink class="nav-link" @onclick="ToggleShitjeSubMenu">
                <i class="oi oi-cart" aria-hidden="true"></i><span>Shitje</span>
            </NavLink>
            @if (showShitjeSubMenu)
            {
                <div class="submenu">
                    @foreach (var category in salesCategories.Where(IsCategoryAllowed))
                    {
                        <NavLink class="@($"nav-link sub {(IsCurrentCategory(category.Code) ? "active-category" : "")}")" 
                                 href="@GetCategoryRoute(category.Code)">
                            <i class="fas fa-angle-right me-2"></i>
                            @(GetLocalizedText(category.NameString?.StringKey))
                        </NavLink>
                    }
                </div>
            }
        </div>
        <div class="nav-item">
            <NavLink class="nav-link" href="levizje-interne">
                <span>Levizje interne</span>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link" href="pagesa">
                <span>Pagesa</span>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link" href="kontabiliteti">
                <span>Kontabiliteti</span>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link" @onclick="ToggleAdminSubMenu" >
                <i class="oi oi-person" aria-hidden="true"></i><span>Administrimi</span>
            </NavLink>
            @if (showAdminSubMenu)
            {
                <div class="submenu">
                    <NavLink class="nav-link sub" href="admin/business-units">
                        <i class="fas fa-store me-2"></i>Business Units
                    </NavLink>
                    <NavLink class="nav-link sub" href="admin/user-business-units">
                        <i class="fas fa-user-shield me-2"></i>User Access
                    </NavLink>
                    <NavLink class="nav-link sub" href="/admin/user-module-access">
                        <i class="fas fa-layer-group me-2"></i>User Modules
                    </NavLink>
                    <NavLink class="nav-link sub" href="admin/invoice-number-settings">
                        <i class="fas fa-hashtag me-2"></i>Invoice Number Format
                    </NavLink>
                    <NavLink class="nav-link sub" href="admin/users">
                        <i class="fas fa-user me-2"></i>Users
                    </NavLink>
                </div>
            }
        </div>
        <div class="nav-item">
            <NavLink class="nav-link" href="articles">
                <i class="oi oi-list-rich" aria-hidden="true"></i><span>Artikulli</span>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link sub" href="change-password">
                <i class="fas fa-key me-2"></i>Change Password
            </NavLink>
        </div>
        <!--
        Remove language switcher for now
        <div class="nav-item">
            <LanguageSwitcher />
        </div>
        -->
        <div class="nav-item">
            <button @onclick="HandleLogoutAsync" class="nav-link btn btn-link logout-btn">
                <span class="oi oi-account-logout" aria-hidden="true"></span> Logout
            </button>
        </div>
    </nav>
</div>

@code {
    private bool showShitjeSubMenu = false;
    private bool showAdminSubMenu = false;
    private List<SalesCategory> salesCategories = new();
    private int defaultLanguageId = 1;
    private string? currentCategory;
    private bool isFirstRender = true;
    private List<Module> allowedModules = new();
    private Dictionary<int, List<Submodule>> allowedSubmodules = new();
    private HashSet<string> allowedSalesVariants = new(StringComparer.OrdinalIgnoreCase);
    private bool allowAllSales = false;

    protected override async Task OnInitializedAsync()
    {
        salesCategories = await StateContainer.GetSalesCategoriesAsync();
        await StateContainer.RefreshSalesCategoriesAsync();
        defaultLanguageId = await LocalizationService.GetDefaultLanguageId();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            allowedModules = await UserModuleAccessService.GetAllowedModulesAsync(userId);

            foreach (var module in allowedModules)
            {
                var submodules = await UserModuleAccessService.GetAllowedSubmodulesAsync(userId, module.Id);
                allowedSubmodules[module.Id] = submodules;
            }

            // Build sales-specific allowed variant list
            // If user has module-level access to Sales, allow all categories
            var salesModule = allowedModules.FirstOrDefault(m =>
                string.Equals(m.RazorPage, "Sales.razor", StringComparison.OrdinalIgnoreCase) ||
                string.Equals(m.Name, "Sales", StringComparison.OrdinalIgnoreCase));

            if (salesModule != null)
            {
                // module-level access -> allow all sales categories
                allowAllSales = true;

                // also collect submodules if present
                var subs = await UserModuleAccessService.GetAllowedSubmodulesAsync(userId, salesModule.Id);
                foreach (var s in subs)
                {
                    if (!string.IsNullOrEmpty(s.VariantCode))
                        allowedSalesVariants.Add(s.VariantCode);
                }
            }
            else
            {
                // if user has no module-level access, collect any submodule-level access for Sales
                // Need to inspect all modules (module-level may not include sales); get modules list
                var allModules = await UserModuleAccessService.GetModulesAsync();
                var salesMod = allModules.FirstOrDefault(m =>
                    string.Equals(m.RazorPage, "Sales.razor", StringComparison.OrdinalIgnoreCase) ||
                    string.Equals(m.Name, "Sales", StringComparison.OrdinalIgnoreCase));

                if (salesMod != null)
                {
                    var subs = await UserModuleAccessService.GetAllowedSubmodulesAsync(userId, salesMod.Id);
                    foreach (var s in subs)
                    {
                        if (!string.IsNullOrEmpty(s.VariantCode))
                            allowedSalesVariants.Add(s.VariantCode);
                    }
                }
            }
        }
    }

    private bool IsCategoryAllowed(SalesCategory category)
    {
        if (allowAllSales) return true;

        // Fallback: if no variant restrictions found for user, show all categories to avoid accidentally hiding everything
        if (allowedSalesVariants.Count == 0) return true;

        return allowedSalesVariants.Contains(category.Code);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                currentCategory = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentSalesCategory");
                isFirstRender = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading category from session storage");
            }
        }
    }

    private void ToggleShitjeSubMenu()
    {
        showShitjeSubMenu = !showShitjeSubMenu;
        if (showShitjeSubMenu)
            showAdminSubMenu = false;

        if (showShitjeSubMenu && !NavigationManager.Uri.ToLower().Contains("/sales"))
        {
            NavigationManager.NavigateTo("/sales");
        }
    }

    private void ToggleAdminSubMenu()
    {
        showAdminSubMenu = !showAdminSubMenu;
        if (showAdminSubMenu)
            showShitjeSubMenu = false;
        // No navigation to /admin here
    }

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += HandleLocationChanged;
        base.OnInitialized();
    }

    private async void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        try
        {
            var currentPath = e.Location.ToLower();
            
            if (!currentPath.Contains("/sales"))
            {
                showShitjeSubMenu = false;
                currentCategory = null;
                await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "currentSalesCategory");
            }
            else
            {
                showShitjeSubMenu = true;
                
                try
                {
                    foreach (var category in salesCategories)
                    {
                        var categoryRoute = GetCategoryRoute(category.Code).ToLower();
                        if (currentPath.EndsWith(categoryRoute))
                        {
                            currentCategory = category.Code;
                            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "currentSalesCategory", category.Code);
                            break;
                        }
                    }

                    if (currentCategory == null || 
                        (currentPath.Contains("/sales/edit/") || System.Text.RegularExpressions.Regex.IsMatch(currentPath, @"/sales/\d+")))
                    {
                        currentCategory = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentSalesCategory");
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error getting category from session storage");
                }
            }
            
            var currentPathLower = currentPath.ToLower();
            if (!currentPathLower.Contains("/admin"))
            {
                showAdminSubMenu = false;
            }
            else
            {
                showAdminSubMenu = true;
            }
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling location change");
        }
    }

    private bool IsCurrentCategory(string? code)
    {
        if (string.IsNullOrEmpty(code)) return false;

        var currentPath = NavigationManager.Uri.ToLower();

        if (currentPath.Contains("/sales/edit/") || 
            System.Text.RegularExpressions.Regex.IsMatch(currentPath, @"/sales/\d+") || 
            currentPath.Contains("/sales/create"))
        {
            return code.Equals(currentCategory, StringComparison.OrdinalIgnoreCase);
        }

        var categoryRoute = GetCategoryRoute(code).ToLower();
        return currentPath.EndsWith(categoryRoute, StringComparison.OrdinalIgnoreCase);
    }

    private async Task HandleLogoutAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.clear");
            await JSRuntime.InvokeVoidAsync("sessionStorage.clear");

            await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/logout'");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout error: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/login'");
        }
    }

    private string GetCategoryRoute(string code)
    {
        return code.ToLower() switch
        {
            "dom" => "sales/domestic",
            "cash" => "sales/cash",
            "exp" => "sales/export",
            "del" => "sales/delivery",
            "serv" => "sales/service",
            "cn" => "sales/credit-note",
            "ret" => "sales/returns",
            "other" => "sales/other",
            "sum" => "sales/summary",
            "print" => "sales/printing",
            "bar" => "sales/barcode",
            _ => "sales"
        };
    }

    private string GetLocalizedText(string? stringKey)
    {
        if (string.IsNullOrEmpty(stringKey))
            return "";

        var languageId = defaultLanguageId;
        
        return LocalizationService.GetString(stringKey, languageId) ?? stringKey;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
    }
}

<style>
    .sidebar {
        width: 280px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        background: linear-gradient(180deg, #1a237e 0%, #0d47a1 100%);
        color: #fff;
        padding: 1rem;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2);
    }

    .nav-header {
        margin-bottom: 2rem;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 1rem;
    }

        .nav-header h4 {
            font-weight: 600;
            margin: 0;
            color: #fff;
            font-size: 1.4rem;
        }

    .nav-item {
        margin-bottom: 0.25rem;
    }

    .nav-link {
        color: rgba(255,255,255,0.9) !important;
        text-decoration: none;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.2s ease;
        margin: 2px 0;
    }

        .nav-link:hover {
            background-color: rgba(255,255,255,0.2); /* Increased from 0.1 to 0.2 */
            color: #fff !important;
            transform: translateX(3px);
        }

        .nav-link.active {
            background-color: rgba(255,255,255,0.35) !important; /* Increased from 0.15 to 0.35 */
            color: #fff !important;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255,255,255,0.1); /* Added subtle glow effect */
        }

        .nav-link.sub {
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.85) !important;
            position: relative;
        }

            .nav-link.sub::before {
                content: '';
                position: absolute;
                left: 1.5rem;
                top: 50%;
                width: 4px;
                height: 4px;
                background-color: rgba(255,255,255,0.5);
                border-radius: 50%;
                transform: translateY(-50%);
            }

            .nav-link.sub:hover::before {
                background-color: #fff;
            }

    .submenu {
        background-color: rgba(0,0,0,0.15);
        border-radius: 8px;
        margin: 0.5rem 0;
        padding: 0.5rem 0;
    }

    .logout-btn {
        width: 100%;
        text-align: left;
        border: none;
        background: none;
        margin-top: 2rem;
        border-top: 1px solid rgba(255,255,255,0.1);
        border-radius: 0;
        padding-top: 1rem;
    }

        .logout-btn:hover {
            background-color: rgba(255,0,0,0.1);
        }

    /* Scrollbar styling */
    .sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.1);
    }

    .sidebar::-webkit-scrollbar-thumb {
        background-color: rgba(255,255,255,0.2);
        border-radius: 3px;
    }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255,255,255,0.3);
        }

    .nav-link.sub.active-category {
        background-color: rgba(255,255,255,0.45) !important; /* Increased from 0.3 to 0.45 */
        color: #fff !important;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(255,255,255,0.1); /* Added subtle glow effect */
    }

    .nav-link i {
        margin-right: 0.75rem;  /* or any desired spacing */
    }
</style>