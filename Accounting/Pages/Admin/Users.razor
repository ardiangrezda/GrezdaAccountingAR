@page "/admin/users"
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Linq
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ILocalizationService LocalizationService
@attribute [Authorize(Roles = "Admin")]

<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="me-4">@usersLabel</h1>
                <div class="d-flex gap-2">
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="@searchUsersPlaceholderLabel"
                               @bind="searchTerm" />
                        <button class="btn btn-primary" @onclick="SearchUsers">
                            <i class="fas fa-search"></i> @searchUserLabel
                        </button>
                    </div>
                    <button class="btn btn-success" @onclick="CreateUser">
                        <i class="fas fa-plus"></i> @createUserLabel
                    </button>
                </div>
            </div>

            <!-- Users Table Card -->
            <div class="card">
                <div class="card-body">
                    <!-- Pagination Info -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="text-muted">@string.Format(showingLabel, (currentPage - 1) * pageSize + 1, Math.Min(currentPage * pageSize, totalUsers), totalUsers)</span>
                        </div>
                        <div>
                            <nav aria-label="User pagination">
                                <ul class="pagination mb-0">
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                                            @previousLabel
                                        </button>
                                    </li>
                                    
                                    @for (int i = 1; i <= totalPages; i++)
                                    {
                                        var pageNumber = i;
                                        <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(pageNumber)">
                                                @pageNumber
                                            </button>
                                        </li>
                                    }
                                    
                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="NextPage" disabled="@(currentPage >= totalPages)">
                                            @nextLabel
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                    @if (users != null && users.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>@userNameLabel</th>
                                        <th>@emailLabel</th>
                                        <th>@firstNameLabel</th>
                                        <th>@lastNameLabel</th>
                                        <th>@phoneLabel</th>
                                        <th>@roleLabel</th>
                                        <th>@statusLabel</th>
                                        <th>@actionsLabel</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var userWithRoles in users)
                                    {
                                        <tr>
                                            <td>@userWithRoles.User.UserName</td>
                                            <td>@userWithRoles.User.Email</td>
                                            <td>@userWithRoles.User.FirstName</td>
                                            <td>@userWithRoles.User.LastName</td>
                                            <td>@userWithRoles.User.PhoneNumber</td>
                                            <td>@string.Join(", ", userWithRoles.Roles)</td>
                                            <td>
                                                @if (userWithRoles.User.IsActive)
                                                {
                                                    <span class="badge bg-success">@activeLabel</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">@inactiveLabel</span>
                                                }
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-warning me-1" @onclick="() => OpenChangePasswordModal(userWithRoles.User)">
                                                    <i class="fas fa-key"></i> @changePasswordLabel
                                                </button>
                                                
                                                @if (userWithRoles.User.IsActive)
                                                {
                                                    <button class="btn btn-sm btn-secondary" @onclick="() => DisableUser(userWithRoles.User)">
                                                        <i class="fas fa-user-slash"></i> @disableUserLabel
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-success" @onclick="() => EnableUser(userWithRoles.User)">
                                                        <i class="fas fa-user-check"></i> @enableUserLabel
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            No users found.
                        </div>
                    }

                    <!-- Bottom Pagination -->
                    <div class="d-flex justify-content-end mt-3">
                        <nav aria-label="User pagination">
                            <ul class="pagination mb-0">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                                        @previousLabel
                                    </button>
                                </li>
                                
                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    var pageNumber = i;
                                    <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(pageNumber)">
                                            @pageNumber
                                        </button>
                                    </li>
                                }
                                
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="NextPage" disabled="@(currentPage >= totalPages)">
                                        @nextLabel
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (showChangePasswordModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@changePasswordForLabel @selectedUser?.UserName</h5>
                    <button type="button" class="btn-close" @onclick="CloseChangePasswordModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@changePasswordModel" OnValidSubmit="HandleChangePassword" autocomplete="off">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div style="display:none;">
                            <input type="text" name="fake-username" autocomplete="username" />
                            <input type="password" name="fake-password" autocomplete="current-password" />
                        </div>

                        <div class="mb-3">
                            <label>@newPasswordLabel</label>
                            <InputText @bind-Value="changePasswordModel.NewPassword"
                                       type="password"
                                       class="form-control"
                                       autocomplete="off"
                                       data-lpignore="true"
                                       data-form-type="other" />
                        </div>
                        <div class="mb-3">
                            <label>@confirmPasswordLabel</label>
                            <InputText @bind-Value="changePasswordModel.ConfirmPassword"
                                       type="password"
                                       class="form-control"
                                       autocomplete="off"
                                       data-lpignore="true"
                                       data-form-type="other" />
                        </div>
                        <button type="submit" class="btn btn-primary">@changePasswordLabel</button>
                        <button type="button" class="btn btn-secondary ms-2" @onclick="CloseChangePasswordModal">Cancel</button>
                    </EditForm>
                    @if (!string.IsNullOrEmpty(changePasswordMessage))
                    {
                        <div class="alert alert-danger mt-2" role="alert">
                            @changePasswordMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (showSuccessModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@successLabel</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success" role="alert">
                        @successMessage
                    </div>
                    <button class="btn btn-primary" @onclick="OnSuccessOk">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string searchTerm = "";
    private List<UserWithRoles> users = new();
    private bool showChangePasswordModal = false;
    private bool showSuccessModal = false;
    private ApplicationUser? selectedUser;
    private ChangePasswordModel changePasswordModel = new();
    private string changePasswordMessage = "";
    private string successMessage = "";
    
    // Pagination properties
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalUsers = 0;
    private int totalPages => (int)Math.Ceiling((double)totalUsers / pageSize);
    
    // Localization strings
    private string createUserLabel = string.Empty;
    private string firstNameLabel = string.Empty;
    private string lastNameLabel = string.Empty;
    private string userNameLabel = string.Empty;
    private string emailLabel = string.Empty;
    private string phoneLabel = string.Empty;
    private string roleLabel = string.Empty;
    private string usersLabel = string.Empty;
    private string searchUsersPlaceholderLabel = string.Empty;
    private string actionsLabel = string.Empty;
    private string changePasswordLabel = string.Empty;
    private string searchUserLabel = string.Empty;
    private string successLabel = string.Empty;
    private string passwordChangeSuccessLabel = string.Empty;
    private string newPasswordLabel = string.Empty;
    private string confirmPasswordLabel = string.Empty;
    private string changePasswordForLabel = string.Empty;
    private string passwordsDoNotMatchLabel = string.Empty;
    private string enableUserLabel = string.Empty;
    private string disableUserLabel = string.Empty;
    private string userEnabledSuccessLabel = string.Empty;
    private string userDisabledSuccessLabel = string.Empty;
    private string statusLabel = string.Empty;
    private string activeLabel = string.Empty;
    private string inactiveLabel = string.Empty;
    private string previousLabel = string.Empty;
    private string nextLabel = string.Empty;
    private string showingLabel = string.Empty;
    private string pageLabel = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadLocalizationStrings();
        await LoadUsers();
    }

    private async Task LoadLocalizationStrings()
    {
        var languageId = await LocalizationService.GetDefaultLanguageId();

        createUserLabel = LocalizationService.GetString("STRING_00207", languageId) ?? "Create User";
        firstNameLabel = LocalizationService.GetString("STRING_00208", languageId) ?? "First Name";
        lastNameLabel = LocalizationService.GetString("STRING_00209", languageId) ?? "Last Name";
        userNameLabel = LocalizationService.GetString("STRING_00210", languageId) ?? "User Name";
        emailLabel = LocalizationService.GetString("STRING_00085", languageId) ?? "Email";
        phoneLabel = LocalizationService.GetString("STRING_00048", languageId) ?? "Telephone";
        roleLabel = LocalizationService.GetString("STRING_00212", languageId) ?? "Role";
        usersLabel = LocalizationService.GetString("STRING_00183", languageId) ?? "Users";
        searchUsersPlaceholderLabel = LocalizationService.GetString("STRING_00241", languageId) ?? "Search users...";
        actionsLabel = LocalizationService.GetString("STRING_00039", languageId) ?? "Actions";
        changePasswordLabel = LocalizationService.GetString("STRING_00185", languageId) ?? "Change Password";
        searchUserLabel = LocalizationService.GetString("STRING_00242", languageId) ?? "Search user";
        successLabel = LocalizationService.GetString("STRING_00214", languageId) ?? "Success";
        passwordChangeSuccessLabel = LocalizationService.GetString("STRING_00243", languageId) ?? "Password change successful.";
        newPasswordLabel = LocalizationService.GetString("STRING_00244", languageId) ?? "New Password";
        confirmPasswordLabel = LocalizationService.GetString("STRING_00245", languageId) ?? "Confirm Password";
        changePasswordForLabel = LocalizationService.GetString("STRING_00246", languageId) ?? "Change Password for";
        passwordsDoNotMatchLabel = LocalizationService.GetString("STRING_00247", languageId) ?? "Passwords do not match.";
        enableUserLabel = LocalizationService.GetString("STRING_00248", languageId) ?? "Enable User";
        disableUserLabel = LocalizationService.GetString("STRING_00249", languageId) ?? "Disable User";
        userEnabledSuccessLabel = LocalizationService.GetString("STRING_00250", languageId) ?? "User enabled successfully.";
        userDisabledSuccessLabel = LocalizationService.GetString("STRING_00251", languageId) ?? "User disabled successfully.";
        statusLabel = LocalizationService.GetString("STRING_00252", languageId) ?? "Status";
        activeLabel = LocalizationService.GetString("STRING_00253", languageId) ?? "Active";
        inactiveLabel = LocalizationService.GetString("STRING_00254", languageId) ?? "Inactive";
        previousLabel = LocalizationService.GetString("STRING_00255", languageId) ?? "Previous";
        nextLabel = LocalizationService.GetString("STRING_00256", languageId) ?? "Next";
        showingLabel = LocalizationService.GetString("STRING_00257", languageId) ?? "Showing {0} to {1} of {2} users";
        pageLabel = LocalizationService.GetString("STRING_00258", languageId) ?? "Page";
    }

    private async Task LoadUsers()
    {
        var allUsers = UserManager.Users;

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            allUsers = allUsers.Where(u => u.UserName!.Contains(searchTerm) || u.Email!.Contains(searchTerm));
        }

        // Get total count for pagination
        totalUsers = await allUsers.CountAsync();

        // Apply pagination
        var userList = await allUsers
            .OrderBy(u => u.UserName)
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToListAsync();

        users = new List<UserWithRoles>();
        foreach (var user in userList)
        {
            var roles = await UserManager.GetRolesAsync(user);
            users.Add(new UserWithRoles
            {
                User = user,
                Roles = roles.ToList()
            });
        }
    }

    private async Task SearchUsers()
    {
        currentPage = 1; // Reset to first page when searching
        await LoadUsers();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadUsers();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadUsers();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadUsers();
        }
    }

    private void CreateUser()
    {
        Navigation.NavigateTo("/admin/create-user");
    }

    private void OpenChangePasswordModal(ApplicationUser user)
    {
        selectedUser = user;
        changePasswordModel = new ChangePasswordModel();
        changePasswordMessage = "";
        showChangePasswordModal = true;
    }

    private void CloseChangePasswordModal()
    {
        showChangePasswordModal = false;
        selectedUser = null;
        changePasswordModel = new();
        changePasswordMessage = "";
    }

    private async Task HandleChangePassword()
    {
        if (selectedUser is null)
            return;

        if (changePasswordModel.NewPassword != changePasswordModel.ConfirmPassword)
        {
            changePasswordMessage = passwordsDoNotMatchLabel;
            return;
        }

        var token = await UserManager.GeneratePasswordResetTokenAsync(selectedUser);
        var result = await UserManager.ResetPasswordAsync(selectedUser, token, changePasswordModel.NewPassword);

        if (result.Succeeded)
        {
            showChangePasswordModal = false;
            successMessage = passwordChangeSuccessLabel;
            showSuccessModal = true;
            changePasswordMessage = "";
        }
        else
        {
            changePasswordMessage = string.Join(", ", result.Errors.Select(e => e.Description));
        }
    }

    private async Task EnableUser(ApplicationUser user)
    {
        user.IsActive = true;
        var result = await UserManager.UpdateAsync(user);
        
        if (result.Succeeded)
        {
            successMessage = userEnabledSuccessLabel;
            showSuccessModal = true;
            await LoadUsers();
        }
    }

    private async Task DisableUser(ApplicationUser user)
    {
        user.IsActive = false;
        var result = await UserManager.UpdateAsync(user);
        
        if (result.Succeeded)
        {
            successMessage = userDisabledSuccessLabel;
            showSuccessModal = true;
            await LoadUsers();
        }
    }

    private void OnSuccessOk()
    {
        showSuccessModal = false;
        showChangePasswordModal = false;
        successMessage = "";
        StateHasChanged();
    }

    public class UserWithRoles
    {
        public ApplicationUser User { get; set; } = null!;
        public List<string> Roles { get; set; } = new();
    }

    public class ChangePasswordModel
    {
        [Required]
        [MinLength(6)]
        public string NewPassword { get; set; } = string.Empty;

        [Required]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
