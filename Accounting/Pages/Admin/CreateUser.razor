@page "/admin/create-user"
@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using Services
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Navigation
@inject ILocalizationService LocalizationService

@attribute [Authorize(Roles = "Admin")]

<h1 style="margin-top:40px;">@createUserLabel</h1>

<EditForm Model="@newUser" OnValidSubmit="HandleCreateUser">
    <DataAnnotationsValidator />

    <div style="max-width: 500px; margin: 30px auto; border: 1px solid #ddd; border-radius: 8px; padding: 32px; background: #fafbfc;">
        <table style="width:100%;">
            <tr>
                <td style="padding:8px;"><label>@firstNameLabel:</label></td>
                <td style="padding:8px;">
                    <InputText @bind-Value="newUser.FirstName" class="form-control" />
                    <ValidationMessage For="@(() => newUser.FirstName)" />
                </td>
            </tr>
            <tr>
                <td style="padding:8px;"><label>@lastNameLabel:</label></td>
                <td style="padding:8px;">
                    <InputText @bind-Value="newUser.LastName" class="form-control" />
                    <ValidationMessage For="@(() => newUser.LastName)" />
                </td>
            </tr>
            <tr>
                <td style="padding:8px;"><label>@userNameLabel:</label></td>
                <td style="padding:8px;">
                    <InputText @bind-Value="newUser.UserName" class="form-control" autocomplete="off" />
                    <ValidationMessage For="@(() => newUser.UserName)" />
                </td>
            </tr>
            <tr>
                <td style="padding:8px;"><label>@emailLabel:</label></td>
                <td style="padding:8px;">
                    <InputText @bind-Value="newUser.Email" class="form-control" />
                    <ValidationMessage For="@(() => newUser.Email)" />
                </td>
            </tr>
            <tr>
                <td style="padding:8px;"><label>@phoneLabel:</label></td>
                <td style="padding:8px;">
                    <InputText @bind-Value="newUser.Phone" class="form-control" />
                </td>
            </tr>
            <tr>
                <td style="padding:8px;"><label>@passwordLabel:</label></td>
                <td style="padding:8px;">
                    <InputText @bind-Value="newUser.Password" type="password" class="form-control" placeholder="Password" autocomplete="new-password" />
                    <ValidationMessage For="@(() => newUser.Password)" />
                </td>
            </tr>
            <tr>
                <td style="padding:8px;"><label>@roleLabel:</label></td>
                <td style="padding:8px;">
                    <InputSelect @bind-Value="newUser.Role" class="form-control">
                        <option value="">-- Select Role --</option>
                        @foreach (var role in roles)
                        {
                            <option value="@role">@role</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => newUser.Role)" />
                </td>
            </tr>
            <tr>
                <td></td>
                <td style="padding:8px;">
                    <button type="submit" class="btn btn-primary" style="margin-right:10px;">@createLabel</button>
                    <button type="button" class="btn btn-secondary" @onclick="Cancel">@cancelLabel</button>
                </td>
            </tr>
        </table>
        @if (!string.IsNullOrEmpty(message))
        {
            <div style="margin-top:16px;">@message</div>
        }
    </div>
</EditForm>

@if (showSuccessModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@successLabel</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success" role="alert">
                        @userCreatedSuccessfullyLabel
                    </div>
                    <button class="btn btn-primary" @onclick="OnSuccessOk">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private NewUserModel newUser = new();
    private string message;
    private List<string> roles = new();
    private bool showSuccessModal = false;
    private string createUserLabel = string.Empty;
    private string firstNameLabel = string.Empty;
    private string lastNameLabel = string.Empty;
    private string userNameLabel = string.Empty;
    private string emailLabel = string.Empty;
    private string phoneLabel = string.Empty;
    private string passwordLabel = string.Empty;
    private string roleLabel = string.Empty;
    private string createLabel = string.Empty;
    private string cancelLabel = string.Empty;
    private string successLabel = string.Empty;
    private string userCreatedSuccessfullyLabel = string.Empty;
    private string userCreateButFailedRoleLabel = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadLocalizationStrings();
        roles = (await RoleManager.Roles.Select(r => r.Name).ToListAsync());
        
        // Set the localization service in the model
        newUser.SetLocalizationService(LocalizationService);
    }

    private async Task LoadLocalizationStrings()
    {
        var languageId = await LocalizationService.GetDefaultLanguageId();

        createUserLabel = LocalizationService.GetString("STRING_00207", languageId) ?? "Create User";
        firstNameLabel = LocalizationService.GetString("STRING_00208", languageId) ?? "First Name";
        lastNameLabel = LocalizationService.GetString("STRING_00209", languageId) ?? "Last Name";
        userNameLabel = LocalizationService.GetString("STRING_00210", languageId) ?? "User Name";
        emailLabel = LocalizationService.GetString("STRING_00085", languageId) ?? "Email";
        phoneLabel = LocalizationService.GetString("STRING_00048", languageId) ?? "Telephone";
        passwordLabel = LocalizationService.GetString("STRING_00211", languageId) ?? "Password";
        roleLabel = LocalizationService.GetString("STRING_00212", languageId) ?? "Role";
        createLabel = LocalizationService.GetString("STRING_00213", languageId) ?? "Create";
        cancelLabel = LocalizationService.GetString("STRING_00153", languageId) ?? "Cancel";
        successLabel = LocalizationService.GetString("STRING_00214", languageId) ?? "Success";
        userCreatedSuccessfullyLabel = LocalizationService.GetString("STRING_00215", languageId) ?? "User created successfully.";
        userCreateButFailedRoleLabel = LocalizationService.GetString("STRING_00224", languageId) ?? "User created, but failed to assign role: ";
    }

    private async Task HandleCreateUser()
    {
        var user = new ApplicationUser
        {
            FirstName = newUser.FirstName,
            LastName = newUser.LastName,
            UserName = newUser.UserName,
            Email = newUser.Email,
            PhoneNumber = newUser.Phone
        };

        var result = await UserManager.CreateAsync(user, newUser.Password);

        if (result.Succeeded)
        {
            var roleResult = await UserManager.AddToRoleAsync(user, newUser.Role);
            if (roleResult.Succeeded)
            {
                showSuccessModal = true;
                message = "";
                return;
            }
            else
            {
                message = userCreateButFailedRoleLabel + string.Join(", ", roleResult.Errors.Select(e => e.Description));
            }
        }
        else
        {
            message = string.Join("\n ", result.Errors.Select(e => e.Description));
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/admin");
    }

    private void OnSuccessOk()
    {
        showSuccessModal = false;
        Navigation.NavigateTo("admin/users");
    }

    public class NewUserModel : IValidatableObject
    {
        private ILocalizationService? _localizationService;

        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;

        public void SetLocalizationService(ILocalizationService localizationService)
        {
            _localizationService = localizationService;
        }

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (_localizationService != null)
            {
                var languageId = _localizationService.GetDefaultLanguageId().Result;

                if (string.IsNullOrEmpty(FirstName))
                {
                    var message = _localizationService.GetString("STRING_00216", languageId) ?? "First Name field is required.";
                    yield return new ValidationResult(message, new[] { nameof(FirstName) });
                }

                if (string.IsNullOrEmpty(LastName))
                {
                    var message = _localizationService.GetString("STRING_00217", languageId) ?? "Last Name field is required.";
                    yield return new ValidationResult(message, new[] { nameof(LastName) });
                }

                if (string.IsNullOrEmpty(UserName))
                {
                    var message = _localizationService.GetString("STRING_00218", languageId) ?? "UserName field is required.";
                    yield return new ValidationResult(message, new[] { nameof(UserName) });
                }

                if (string.IsNullOrEmpty(Email))
                {
                    var message = _localizationService.GetString("STRING_00219", languageId) ?? "Email field is required.";
                    yield return new ValidationResult(message, new[] { nameof(Email) });
                }
                else if (!new EmailAddressAttribute().IsValid(Email))
                {
                    var message = _localizationService.GetString("STRING_00222", languageId) ?? "Formati i email-it nuk është i vlefshëm.";
                    yield return new ValidationResult(message, new[] { nameof(Email) });
                }

                if (string.IsNullOrEmpty(Password))
                {
                    var message = _localizationService.GetString("STRING_00220", languageId) ?? "Password field is required.";
                    yield return new ValidationResult(message, new[] { nameof(Password) });
                }
                else if (Password.Length < 6)
                {
                    var message = _localizationService.GetString("STRING_00223", languageId) ?? "Password must be at least 6 characters.";
                    yield return new ValidationResult(message, new[] { nameof(Password) });
                }

                if (string.IsNullOrEmpty(Role))
                {
                    var message = _localizationService.GetString("STRING_00221", languageId) ?? "Role field is required.";
                    yield return new ValidationResult(message, new[] { nameof(Role) });
                }
            }
        }
    }
}