@using Microsoft.AspNetCore.Identity
@using Models
@using Services
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject SalesCategoryService SalesCategoryService
@inject ILocalizationService LocalizationService
@inject StateContainer StateContainer
@implements IDisposable
@inject ILogger<NavMenu> Logger
@inject UserModuleAccessService UserModuleAccessService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject BusinessUnitService BusinessUnitService

<div class="layout-container">
    <div class="top-bar">
        <div class="app-title">@applicationTitle</div>
        <div class="business-unit">@currentBusinessUnitName</div>
        <div class="user-info">@userName</div>
        <button @onclick="HandleChangePasswordAsync" class="change-password-button">
            <i class="fas fa-key me-2"></i>@changePasswordLabel
        </button>
        <button @onclick="HandleLogoutAsync" class="logout-button">
            <i class="fas fa-sign-out-alt"></i> @logoutLabel
        </button>
    </div>

    <div class="sidebar">
        <nav class="flex-column">
            @if (HasModuleAccess("Subjects", subjectsLabel))
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="subjects">
                        <span>@subjectsLabel</span>
                    </NavLink>
                </div>
            }

            @if (HasModuleAccess("Purchases", purchasesLabel))
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="purchases">
                        <span>@purchasesLabel</span>
                    </NavLink>
                </div>
            }

            @if (HasModuleAccess("Sales", salesLabel))
            {
                <div class="nav-item">
                    <NavLink class="nav-link" @onclick="ToggleSalesSubMenu">
                        <i class="oi oi-cart" aria-hidden="true"></i><span>@salesLabel</span>
                    </NavLink>
                    @if (showSalesSubMenu)
                    {
                        <div class="submenu">
                            @foreach (var category in salesCategories.Where(IsCategoryAllowed))
                            {
                                <NavLink class="@($"nav-link sub {(IsCurrentCategory(category.Code) ? "active-category" : "")}")"
                                         href="@GetCategoryRoute(category.Code)">
                                    <i class="fas fa-angle-right me-2"></i>
                                    @(GetLocalizedText(category.NameString?.StringKey))
                                </NavLink>
                            }
                        </div>
                    }
                </div>
            }

            @if (HasModuleAccess("Internal Transfers", internalTransfersLabel))
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="internal-transfers">
                        <span>@internalTransfersLabel</span>
                    </NavLink>
                </div>
            }

            @if (HasModuleAccess("Payments", paymentsLabel))
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="payments">
                        <span>@paymentsLabel</span>
                    </NavLink>
                </div>
            }

            @if (HasModuleAccess("Accounting", accountingLabel))
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="accounting">
                        <span>@accountingLabel</span>
                    </NavLink>
                </div>
            }

            @if (HasModuleAccess("Articles", articlesLabel))
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="articles">
                        <i class="oi oi-list-rich" aria-hidden="true"></i><span>@articlesLabel</span>
                    </NavLink>
                </div>
            }

            @if (isAdmin)
            {
                <div class="nav-item">
                    <NavLink class="nav-link" @onclick="ToggleAdminSubMenu">
                        <i class="oi oi-person" aria-hidden="true"></i><span>@administrationLabel</span>
                    </NavLink>
                    @if (showAdminSubMenu)
                    {
                        <div class="submenu">
                            <NavLink class="nav-link sub" href="admin/business-units">
                                <i class="fas fa-store me-2"></i>@businessUnitsLabel
                            </NavLink>
                            <NavLink class="nav-link sub" href="admin/user-business-units">
                                <i class="fas fa-user-shield me-2"></i>@userAccessLabel
                            </NavLink>
                            <NavLink class="nav-link sub" href="/admin/user-module-access">
                                <i class="fas fa-layer-group me-2"></i>@userModulesLabel
                            </NavLink>
                            <NavLink class="nav-link sub" href="admin/invoice-number-settings">
                                <i class="fas fa-hashtag me-2"></i>@invoiceNumberFormatLabel
                            </NavLink>
                            <NavLink class="nav-link sub" href="admin/users">
                                <i class="fas fa-user me-2"></i>@usersLabel
                            </NavLink>
                        </div>
                    }
                </div>
            }
        </nav>
    </div>
</div>

@code {
    // --- simple in-memory per-user cache (30 minute TTL) ---
    private class AccessCacheEntry
    {
        public List<Module> AllowedModules { get; set; } = new();
        public Dictionary<int, List<Submodule>> AllowedSubmodules { get; set; } = new();
        public HashSet<string> AllowedSalesVariants { get; set; } = new(StringComparer.OrdinalIgnoreCase);
        public bool AllowAllSales { get; set; }
        public bool IsAdmin { get; set; }
        public DateTimeOffset FetchedAt { get; set; }
    }

    private static readonly System.Collections.Concurrent.ConcurrentDictionary<string, AccessCacheEntry> _accessCache
        = new();

    private static readonly System.Collections.Concurrent.ConcurrentDictionary<string, System.Threading.SemaphoreSlim> _userLocks
        = new();

    private readonly TimeSpan _cacheDuration = TimeSpan.FromMinutes(30);

    private bool showSalesSubMenu = false;
    private bool showAdminSubMenu = false;
    private List<SalesCategory> salesCategories = new();
    private int defaultLanguageId = 1;
    private string? currentCategory;
    private bool isFirstRender = true;
    private List<Module> allowedModules = new();
    private Dictionary<int, List<Submodule>> allowedSubmodules = new();
    private HashSet<string> allowedSalesVariants = new(StringComparer.OrdinalIgnoreCase);
    private bool allowAllSales = false;
    private bool isAdmin = false;

    // Localization strings
    private string subjectsLabel = string.Empty;
    private string purchasesLabel = string.Empty;
    private string salesLabel = string.Empty;
    private string internalTransfersLabel = string.Empty;
    private string paymentsLabel = string.Empty;
    private string accountingLabel = string.Empty;
    private string administrationLabel = string.Empty;
    private string businessUnitsLabel = string.Empty;
    private string userAccessLabel = string.Empty;
    private string userModulesLabel = string.Empty;
    private string invoiceNumberFormatLabel = string.Empty;
    private string usersLabel = string.Empty;
    private string articlesLabel = string.Empty;
    private string changePasswordLabel = string.Empty;
    private string logoutLabel = string.Empty;
    private string errorLoadingCategoryLabel = string.Empty;
    private string errorLocationChangeLabel = string.Empty;
    private string errorGettingCategoryLabel = string.Empty;

    private string userName = string.Empty;
    private string currentBusinessUnitName = string.Empty;
    private string applicationTitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadLocalizationStrings();
        salesCategories = await StateContainer.GetSalesCategoriesAsync();
        await StateContainer.RefreshSalesCategoriesAsync();
        defaultLanguageId = await LocalizationService.GetDefaultLanguageId();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(userId))
            return;

        // Get current business unit
        var businessUnitIdString = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "currentBusinessUnit");
        if (!string.IsNullOrEmpty(businessUnitIdString) && int.TryParse(businessUnitIdString, out var businessUnitId))
        {
            var businessUnit = await BusinessUnitService.GetByIdAsync(businessUnitId);
            currentBusinessUnitName = businessUnit?.Name ?? string.Empty;
        }

        var lockForUser = _userLocks.GetOrAdd(userId, _ => new System.Threading.SemaphoreSlim(1, 1));
        await lockForUser.WaitAsync();
        try
        {
            // Use cached entry if fresh
            if (_accessCache.TryGetValue(userId, out var cached) &&
                (DateTimeOffset.UtcNow - cached.FetchedAt) < _cacheDuration)
            {
                ApplyCacheToLocalState(cached);
                return;
            }

            // Not cached (or expired) -> compute and store
            var entry = await BuildAccessEntryForUser(userId);
            _accessCache[userId] = entry;
            ApplyCacheToLocalState(entry);
        }
        finally
        {
            lockForUser.Release();
        }

        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userName = user.Identity.Name ?? "Unknown User";
        }
        else
        {
            userName = "Guest";
        }
    }

    // Build the access entry by reading the same persisted rows your admin UI saves.
    private async Task<AccessCacheEntry> BuildAccessEntryForUser(string userId)
    {
        var entry = new AccessCacheEntry
        {
            FetchedAt = DateTimeOffset.UtcNow
        };

        // determine role (Admin) using your existing service method
        try
        {
            var rolesMap = await UserModuleAccessService.GetRolesForUsersAsync(new[] { userId });
            if (rolesMap.TryGetValue(userId, out var roles) && !string.IsNullOrEmpty(roles))
            {
                var roleList = roles.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                entry.IsAdmin = roleList.Any(r => string.Equals(r, "Admin", StringComparison.OrdinalIgnoreCase));
            }
        }
        catch
        {
            entry.IsAdmin = false;
        }

        if (entry.IsAdmin)
        {
            entry.AllowAllSales = true;
            entry.AllowedModules = await UserModuleAccessService.GetModulesAsync();
            return entry;
        }

        // Non-admin: use persisted UserModuleAccess rows (this mirrors SaveAccess)
        var accessRows = await UserModuleAccessService.GetUserAccessEntriesAsync(userId);
        var allModules = await UserModuleAccessService.GetModulesAsync();

        var allowedModules = new List<Module>();
        var allowedSubmodules = new Dictionary<int, List<Submodule>>();

        foreach (var module in allModules)
        {
            var rowsForModule = accessRows.Where(e => e.ModuleId == module.Id).ToList();
            if (!rowsForModule.Any()) continue;

            // user has module-level access or some submodule entries
            allowedModules.Add(module);

            // gather allowed submodule ids for this module
            var subIds = rowsForModule.Where(r => r.SubmoduleId != null).Select(r => r.SubmoduleId!.Value).Distinct().ToList();
            var subs = (module.Submodules ?? Enumerable.Empty<Submodule>()).Where(s => subIds.Contains(s.Id)).ToList();

            // fallback: if module.Submodules not loaded, use navigation property on access row
            if (!subs.Any() && subIds.Any())
            {
                subs = accessRows
                    .Where(r => r.ModuleId == module.Id && r.SubmoduleId != null)
                    .Select(r => r.Submodule)
                    .Where(s => s != null)
                    .Select(s => s!)
                    .Distinct()
                    .ToList();
            }

            allowedSubmodules[module.Id] = subs;
        }

        // sales-specific: module-level entry with SubmoduleId == null means allow all
        var salesDef = allModules.FirstOrDefault(m =>
            string.Equals(m.RazorPage, "Sales.razor", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(m.Name, "Sales", StringComparison.OrdinalIgnoreCase));

        if (salesDef != null)
        {
            var moduleLevelEntry = accessRows.FirstOrDefault(e => e.ModuleId == salesDef.Id && e.SubmoduleId == null);
            if (moduleLevelEntry != null)
                entry.AllowAllSales = true;

            var salesSubVariants = accessRows
                .Where(e => e.ModuleId == salesDef.Id && e.SubmoduleId != null)
                .Select(e => e.Submodule)
                .Where(s => s != null && !string.IsNullOrEmpty(s.VariantCode))
                .Select(s => s!.VariantCode!)
                .Distinct(StringComparer.OrdinalIgnoreCase);

            foreach (var v in salesSubVariants)
                entry.AllowedSalesVariants.Add(v);
        }

        entry.AllowedModules = allowedModules;
        entry.AllowedSubmodules = allowedSubmodules;
        return entry;
    }

    // Helper: apply a cache entry to local component state used by rendering logic
    private void ApplyCacheToLocalState(AccessCacheEntry cached)
    {
        allowedModules = cached.AllowedModules ?? new List<Module>();
        allowedSubmodules = cached.AllowedSubmodules ?? new Dictionary<int, List<Submodule>>();
        allowedSalesVariants = cached.AllowedSalesVariants ?? new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        allowAllSales = cached.AllowAllSales;
        isAdmin = cached.IsAdmin;
    }

    // Call this when user logs out so we don't hold stale access for that user
    private async Task HandleLogoutAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                _accessCache.TryRemove(userId, out _);
                _userLocks.TryRemove(userId, out _);
            }

            await JSRuntime.InvokeVoidAsync("localStorage.clear");
            await JSRuntime.InvokeVoidAsync("sessionStorage.clear");
            await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/logout'");
        }
        catch (Exception)
        {
            await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/login'");
        }
    }

    private bool HasModuleAccess(params string[] candidates)
    {
        if (isAdmin) return true;

        // If we couldn't initialize access lists treat as no access
        if (allowedModules == null) return false;

        foreach (var candidate in candidates)
        {
            if (string.IsNullOrWhiteSpace(candidate)) continue;

            // direct module name match
            if (allowedModules.Any(m => string.Equals(m.Name, candidate, StringComparison.OrdinalIgnoreCase)))
                return true;

            // RazorPage match variants
            if (allowedModules.Any(m =>
                !string.IsNullOrEmpty(m.RazorPage) &&
                (string.Equals(m.RazorPage, candidate, StringComparison.OrdinalIgnoreCase) ||
                 string.Equals(m.RazorPage, candidate + ".razor", StringComparison.OrdinalIgnoreCase) ||
                 string.Equals(m.RazorPage, "/" + candidate, StringComparison.OrdinalIgnoreCase))))
            {
                return true;
            }

            // Sales parent: candidate is a string, not a collection — check text instead of Any()
            if (candidate.IndexOf("sales", StringComparison.OrdinalIgnoreCase) >= 0)
            {
                if (allowAllSales) return true;
                if (allowedSalesVariants.Count > 0) return true;
            }
        }

        return false;
    }

    private bool IsCategoryAllowed(SalesCategory category)
    {
        if (allowAllSales) return true;

        if (allowedSalesVariants.Count == 0) return true;

        return allowedSalesVariants.Contains(category.Code);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                currentCategory = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentSalesCategory");
                isFirstRender = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, @errorLoadingCategoryLabel);
            }
        }
    }

    private void ToggleSalesSubMenu()
    {
        showSalesSubMenu = !showSalesSubMenu;
        if (showSalesSubMenu)
            showAdminSubMenu = false;

        if (showSalesSubMenu && !NavigationManager.Uri.ToLower().Contains("/sales"))
        {
            NavigationManager.NavigateTo("/sales");
        }
    }

    private void ToggleAdminSubMenu()
    {
        showAdminSubMenu = !showAdminSubMenu;
        if (showAdminSubMenu)
            showSalesSubMenu = false;
    }

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += HandleLocationChanged;
        base.OnInitialized();
    }

    private async void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        try
        {
            var currentPath = e.Location.ToLower();

            if (!currentPath.Contains("/sales"))
            {
                showSalesSubMenu = false;
                currentCategory = null;
                await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "currentSalesCategory");
            }
            else
            {
                showSalesSubMenu = true;

                try
                {
                    foreach (var category in salesCategories)
                    {
                        var categoryRoute = GetCategoryRoute(category.Code).ToLower();
                        if (currentPath.EndsWith(categoryRoute))
                        {
                            currentCategory = category.Code;
                            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "currentSalesCategory", category.Code);
                            break;
                        }
                    }

                    if (currentCategory == null || 
                        (currentPath.Contains("/sales/edit/") || System.Text.RegularExpressions.Regex.IsMatch(currentPath, @"/sales/\d+")))
                    {
                        currentCategory = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentSalesCategory");
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, errorGettingCategoryLabel);
                }
            }

            var currentPathLower = currentPath.ToLower();
            if (!currentPathLower.Contains("/admin"))
            {
                showAdminSubMenu = false;
            }
            else
            {
                showAdminSubMenu = true;
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, errorLocationChangeLabel);
        }
    }

    private bool IsCurrentCategory(string? code)
    {
        if (string.IsNullOrEmpty(code)) return false;

        var currentPath = NavigationManager.Uri.ToLower();

        if (currentPath.Contains("/sales/edit/") || 
            System.Text.RegularExpressions.Regex.IsMatch(currentPath, @"/sales/\d+") || 
            currentPath.Contains("/sales/create"))
        {
            return code.Equals(currentCategory, StringComparison.OrdinalIgnoreCase);
        }

        var categoryRoute = GetCategoryRoute(code).ToLower();
        return currentPath.EndsWith(categoryRoute, StringComparison.OrdinalIgnoreCase);
    }

    private string GetCategoryRoute(string code)
    {
        return code.ToLower() switch
        {
            "dom" => "sales/domestic",
            "cash" => "sales/cash",
            "exp" => "sales/export",
            "del" => "sales/delivery",
            "serv" => "sales/service",
            "cn" => "sales/credit-note",
            "ret" => "sales/returns",
            "other" => "sales/other",
            "sum" => "sales/summary",
            "print" => "sales/printing",
            "bar" => "sales/barcode",
            _ => "sales"
        };
    }

    private string GetLocalizedText(string? stringKey)
    {
        if (string.IsNullOrEmpty(stringKey))
            return "";

        var languageId = defaultLanguageId;

        return LocalizationService.GetString(stringKey, languageId) ?? stringKey;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
    }

    private async Task LoadLocalizationStrings()
    {
        var languageId = await LocalizationService.GetDefaultLanguageId();
            
        subjectsLabel = LocalizationService.GetString("STRING_00031", languageId) ?? "Subjects";
        purchasesLabel = LocalizationService.GetString("STRING_00173", languageId) ?? "Purchases";
        salesLabel = LocalizationService.GetString("STRING_00174", languageId) ?? "Sales";
        internalTransfersLabel = LocalizationService.GetString("STRING_00175", languageId) ?? "Internal Transfers";
        paymentsLabel = LocalizationService.GetString("STRING_00176", languageId) ?? "Payments";
        accountingLabel = LocalizationService.GetString("STRING_00177", languageId) ?? "Accounting";
        administrationLabel = LocalizationService.GetString("STRING_00178", languageId) ?? "Administration";
        businessUnitsLabel = LocalizationService.GetString("STRING_00179", languageId) ?? "Business Units";
        userAccessLabel = LocalizationService.GetString("STRING_00180", languageId) ?? "User Access";
        userModulesLabel = LocalizationService.GetString("STRING_00181", languageId) ?? "User Modules";
        invoiceNumberFormatLabel = LocalizationService.GetString("STRING_00182", languageId) ?? "Invoice Number Format";
        usersLabel = LocalizationService.GetString("STRING_00183", languageId) ?? "Users";
        articlesLabel = LocalizationService.GetString("STRING_00184", languageId) ?? "Articles";
        changePasswordLabel = LocalizationService.GetString("STRING_00185", languageId) ?? "Change Password";
        logoutLabel = LocalizationService.GetString("STRING_00186", languageId) ?? "Logout";
        errorLoadingCategoryLabel = LocalizationService.GetString("STRING_00187", languageId) ?? "Error loading current sales category from session storage.";
        errorLocationChangeLabel = LocalizationService.GetString("STRING_00188", languageId) ?? "Error changing location change";
        errorGettingCategoryLabel = LocalizationService.GetString("STRING_00189", languageId) ?? "Error getting sales category from session storage";
        applicationTitle = LocalizationService.GetString("STRING_00205", languageId) ?? "Accounting System";
    }
    private void HandleChangePasswordAsync()
    {
        NavigationManager.NavigateTo("change-password");
    }
}

<style>
    /* Top bar styles - FIXED */
    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background-color: #283593;
        color: white;
        display: flex !important;
        align-items: center;
        padding: 0 20px;
        z-index: 1050;
        gap: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        visibility: visible !important;
    }

    /* Top bar elements */
    .app-title {
        font-size: 1rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .business-unit,
    .user-info {
        padding: 4px 8px;
        border-radius: 4px;
        background: rgba(255,255,255,0.15);
        font-size: 0.85rem;
    }

    .business-unit {
        margin-right: auto;
    }

    .logout-button,
    .change-password-button {
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
    }

    .logout-button:hover,
    .change-password-button:hover {
        background: rgba(255,255,255,0.25);
    }

    .sidebar {
        width: 280px;
        height: calc(100vh - 60px);
        position: fixed;
        top: 60px;
        left: 0;
        background: linear-gradient(180deg, #1a237e 0%, #0d47a1 100%);
        color: #fff;
        padding: 1rem;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2);
    }

    .flex-column {
        padding-top: 10px;
    }

    .nav-header {
        margin-bottom: 2rem;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 1rem;
    }

    .nav-header h4 {
        font-weight: 600;
        margin: 0;
        color: #fff;
        font-size: 1.4rem;
    }

    .nav-item {
        margin-bottom: 0.15rem;
    }

    .nav-link {
        color: rgba(255,255,255,0.9) !important;
        text-decoration: none;
        padding: 0.4rem 0.8rem;
        display: flex;
        align-items: center;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.2s ease;
        margin: 1px 0;
        font-size: 0.9rem;
    }

    .nav-link:hover {
        background-color: rgba(255,255,255,0.2);
        color: #fff !important;
        transform: translateX(3px);
    }

    .nav-link.active {
        background-color: rgba(255,255,255,0.35) !important;
        color: #fff !important;
        font-weight: 600;
        box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }

    .nav-link.sub {
        padding: 0.35rem 0.8rem 0.35rem 2rem;
        font-size: 0.84rem;
        color: rgba(255,255,255,0.85) !important;
        position: relative;
    }

    .nav-link.sub::before {
        content: '';
        position: absolute;
        left: 1.2rem;
        top: 50%;
        width: 3px;
        height: 3px;
        background-color: rgba(255,255,255,0.5);
        border-radius: 50%;
        transform: translateY(-50%);
    }

    .nav-link.sub:hover::before {
        background-color: #fff;
    }

    .submenu {
        background-color: rgba(0,0,0,0.15);
        border-radius: 8px;
        margin: 0.3rem 0;
        padding: 0.3rem 0;
    }

    .logout-btn {
        width: 100%;
        text-align: left;
        border: none;
        background: none;
        margin-top: 1.5rem;
        border-top: 1px solid rgba(255,255,255,0.1);
        border-radius: 0;
        padding-top: 0.8rem;
        font-size: 0.9rem;
    }

    .logout-btn:hover {
        background-color: rgba(255,0,0,0.1);
    }

    .sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.1);
    }

    .sidebar::-webkit-scrollbar-thumb {
        background-color: rgba(255,255,255,0.2);
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255,255,255,0.3);
    }

    .nav-link.sub.active-category {
        background-color: rgba(255,255,255,0.45) !important;
        color: #fff !important;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }

    .nav-link i {
        margin-right: 0.5rem;
        font-size: 0.84rem;
    }
</style>